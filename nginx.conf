worker_processes  auto;

events {
    worker_connections  1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;

    sendfile           on;
    tcp_nopush         on;
    keepalive_timeout  65;
    client_max_body_size 10m;  # Match Express body-parser limit

    # Gzip compression
    gzip              on;
    gzip_vary         on;
    gzip_min_length   1024;
    gzip_proxied      any;
    gzip_comp_level   5;
    gzip_types
        text/plain
        text/css
        text/javascript
        application/javascript
        application/json
        application/xml
        image/svg+xml;

    # Backend upstream
    upstream physio_backend {
        server 127.0.0.1:3000;
        keepalive 16;
    }

    server {
        listen       80;
        server_name  localhost;  # Change to your domain in production (e.g. clinica.example.com)

        # ---------------------------------------------------------------
        # 1. Socket.IO — must come before the general backend proxy block
        # ---------------------------------------------------------------
        location /socket.io/ {
            proxy_pass         http://physio_backend;
            proxy_http_version 1.1;
            proxy_buffering    off;
            proxy_set_header   Upgrade $http_upgrade;
            proxy_set_header   Connection "Upgrade";
            proxy_set_header   Host $host;
            proxy_set_header   X-Real-IP $remote_addr;
            proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header   X-Forwarded-Proto $scheme;
            proxy_read_timeout 3600s;  # Hold long-lived WebSocket connections
        }

        # ---------------------------------------------------------------
        # 2. Backend routes — API, auth, and server-rendered pages
        # ---------------------------------------------------------------
        location ~ ^/(login|logout|api|patients|therapists|therapist|availability|portal|admin|doctor|secretary) {
            proxy_pass         http://physio_backend;
            proxy_http_version 1.1;
            proxy_set_header   Host $host;
            proxy_set_header   X-Real-IP $remote_addr;
            proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header   X-Forwarded-Proto $scheme;  # Lets Express detect HTTPS for secure cookies
            proxy_set_header   Connection '';
            proxy_connect_timeout 10s;
            proxy_read_timeout    30s;
            proxy_send_timeout    30s;
        }

        # ---------------------------------------------------------------
        # 3. React/Vite static build — must come last
        #    CHANGE this path to match your deployment directory
        # ---------------------------------------------------------------
        location / {
            root       "d:/fisitriabienporfa/physio-clinic-app/client/dist";  # UPDATE for each machine
            index      index.html;
            try_files  $uri $uri/ /index.html;

            # Cache busted JS/CSS files (Vite fingerprints filenames)
            location ~* \.(js|css)$ {
                expires    1y;
                add_header Cache-Control "public, immutable";
            }

            # Short cache for images and fonts
            location ~* \.(png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf)$ {
                expires    30d;
                add_header Cache-Control "public";
            }
        }

        # Error pages
        error_page  500 502 503 504  /50x.html;
        location = /50x.html {
            root html;
        }
    }
}
